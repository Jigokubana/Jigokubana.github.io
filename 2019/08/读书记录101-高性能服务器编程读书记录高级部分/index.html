<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="keywords" content="hexo,ä¸ªäººåšå®¢,blog" />
  <meta name="description" content="å½¼å²¸é±¼çš„ä¸ªäººåšå®¢" />
  <meta http-equiv="x-dns-prefetch-control" content="on">
  <link rel="dns-prefetch" href="https://busuanzi.ibruce.info">
  <link rel="dns-prefetch" href="https://at.alicdn.com">
  
  <link rel="dns-prefetch" href="https://widget.daovoice.io">
  <link rel="dns-prefetch" href="https://widget-static-cdn.daovoice.io">
  <link rel="dns-prefetch" href="https://im.daovoice.io">
  
  
  <link rel="dns-prefetch" href="https://hm.baidu.com/">
  
  
  <link rel="stylesheet" type="text/css" href="/./style/main.css">
	<link rel="shortcut icon" href="/favicon.ico" title="Favicon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
	<title>Linuxé«˜æ€§èƒ½æœåŠ¡å™¨-é«˜çº§éƒ¨åˆ†</title>
  
  <script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?378fe7f014810dc29a0702bf27d8b278";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();
  </script>
  
  
    <script>(function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/9c4ca997.js","daovoice");daovoice('init',{app_id: "9c4ca997"});daovoice('update');
  </script>
  
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Lsmgçš„å¤§å­¦ä¹‹è·¯" type="application/atom+xml">
</head>
<body>
  <canvas id="pattern-placeholder" height="230"></canvas>
<div class="navbar-header">
  <a class="blog-title" href="/">Lsmgçš„å¤§å­¦ä¹‹è·¯</a>
  <a class="face-img" href="/">
    <img src="https://lsmg-img.oss-cn-beijing.aliyuncs.com/theme/tx.jpg">
  </a>
</div>
<main>
  <div class="article-title">
    
  
  <h1 class="title">
    Linuxé«˜æ€§èƒ½æœåŠ¡å™¨-é«˜çº§éƒ¨åˆ†
  </h1>
  


    <ul class="article-info">
      <li>
        å‘å¸ƒ
        <time datetime="2019-08-18T12:34:39.000Z" itemprop="datePublished">2019-08-18</time>
      </li>
      <li>
        
    æ›´æ–° <time datetime="2020-12-05T02:31:35.595Z" itemprop="dateUpdated">2020-12-05</time>

      </li>
      <li id="busuanzi_container_page_pv">
        é˜…è¯» <span id="busuanzi_value_page_pv"></span>
      </li>
    </ul>
  </div>
  <div class="container">
    <div class="article">
      <div class="content">
        
        <h1 id="ç¬¬ä¹ç« -I-Oå¤ç”¨"><a href="#ç¬¬ä¹ç« -I-Oå¤ç”¨" class="headerlink" title="ç¬¬ä¹ç«  I/Oå¤ç”¨"></a>ç¬¬ä¹ç«  I/Oå¤ç”¨</h1><p>I/Oå¤ç”¨ä½¿å¾—ç¨‹åºèƒ½åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦.</p>
<ul>
<li>å®¢æˆ·ç«¯ç¨‹åºéœ€è¦åŒæ—¶å¤„ç†å¤šä¸ªsocket éé˜»å¡connectæŠ€æœ¯</li>
<li>å®¢æˆ·ç«¯ç¨‹åºåŒæ—¶å¤„ç†ç”¨æˆ·è¾“å…¥å’Œç½‘ç»œè¿æ¥ èŠå¤©å®¤ç¨‹åº</li>
<li>TCPæœåŠ¡å™¨è¦åŒæ—¶å¤„ç†ç›‘å¬socketå’Œè¿æ¥socket</li>
<li>åŒæ—¶å¤„ç†TCPå’ŒUDPè¯·æ±‚ - å›å°„æœåŠ¡å™¨</li>
<li>åŒæ—¶ç›‘å¬å¤šä¸ªç«¯å£, æˆ–è€…å¤„ç†å¤šç§æœåŠ¡ - xinetdæœåŠ¡å™¨</li>
</ul>
<p>å¸¸ç”¨æ‰‹æ®µ<code>select</code>, <code>poll</code>, <code>epoll</code></p>
<h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// maxfdp ä¸€èˆ¬è®¾ç½®ä¸ºæœ€å¤§æè¿°ç¬¦+1, å› ä¸ºè¿™é‡Œè¡¨ç¤ºçš„æ˜¯æ•°é‡ è€Œæè¿°ç¬¦ä»0å¼€å§‹</span></span><br><span class="line"><span class="comment">// readfds  éœ€è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦è¯»å˜åŒ–, å…¶ä¸­çš„æ–‡ä»¶æè¿°ç¬¦å¯è¯»çš„æ—¶å€™è¿”å›</span></span><br><span class="line"><span class="comment">// writefds éœ€è¦ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦å†™å˜åŒ–, å…¶ä¸­çš„æ–‡ä»¶æè¿°ç¬¦å¯å†™çš„æ—¶å€™è¿”å›</span></span><br><span class="line"><span class="comment">// errorfds é”™è¯¯</span></span><br><span class="line"><span class="comment">// timeout ä¼ å…¥NULLä¸ºé˜»å¡, è®¾ç½®ä¸º0ç§’0å¾®ç§’åˆ™å˜ä¸ºéé˜»å¡å‡½æ•°</span></span><br><span class="line"><span class="comment">// è¿”å›å€¼ è´Ÿå€¼ä¸ºé”™è¯¯ ç­‰å¾…è¶…æ—¶è¯´æ˜æ–‡ä»¶æ— å˜åŒ–è¿”å›0 æœ‰å˜åŒ–è¿”å›æ­£å€¼</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">int</span> maxfdp,fd_set *readfds,fd_set *writefds,fd_set *errorfds,struct timeval*timeout)</span></span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">//æ“ä½œfd_setçš„å®</span></span><br><span class="line">FD_ZERO(fd_set* fdset);</span><br><span class="line">FD_SET(<span class="keyword">int</span> fd, fd_set* fdset);</span><br><span class="line">FD_CLR(<span class="keyword">int</span> fd, fd_set* fdset);</span><br><span class="line">FD_ISSET(<span class="keyword">int</span> fd, fd_set* fdset);</span><br><span class="line"><span class="comment">// è®¾ç½® timeval è¶…æ—¶æ—¶é—´</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">long</span> tv_sec; <span class="comment">// ç§’</span></span><br><span class="line">	<span class="keyword">long</span> tv_usec; <span class="comment">// å¾®ç§’</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>struct fd_set ä¸€ä¸ªé›†åˆ,å¯ä»¥å­˜å‚¨å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦<br>å†…éƒ¨æ˜¯ä¸€ä¸ª32ä½æ•´æ•°çš„æ•°ç»„, æ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ å¯¹åº”0<del>31æè¿°ç¬¦ ä¸€ä¸ªäºŒè¿›åˆ¶ä½ä»£è¡¨ä¸€ä¸ªæè¿°ç¬¦<br>æ•°ç»„ç¬¬äºŒä¸ªå…ƒç´ å¯¹åº”32</del>63 ä»¥æ­¤ç±»æ¨</p>
<p>å¯è¯»æ¡ä»¶</p>
<ul>
<li>socketå†…æ ¸æ¥æ”¶ç¼“å­˜åŒºä¸­çš„å­—èŠ‚æ•°å¤§äºæˆ–ç­‰äº å…¶ä½æ°´ä½æ ‡è®°</li>
<li>socketé€šä¿¡çš„å¯¹æ–¹å…³é—­è¿æ¥ è¯»åŠè¿æ¥å…³é—­, å¯¹socketçš„è¯»æ“ä½œè¿”å›0</li>
<li>ç›‘å¬socketä¸Šæœ‰æ–°çš„è¿æ¥è¯·æ±‚</li>
<li>socketä¸Šæœ‰æœªå¤„ç†çš„é”™è¯¯, å¯ä»¥ä½¿ç”¨getsockoptçš„SO_ERRORæ¥è¯»å–å’Œæ¸…é™¤é”™è¯¯ å¥—æ¥å­—çš„è¯»æ“ä½œä¸é˜»å¡ å¹¶è¿”å›-1</li>
</ul>
<p>å¯å†™æ¡ä»¶</p>
<ul>
<li>socketå†…æ ¸çš„å‘é€ç¼“å†²åŒºçš„å¯ç”¨å­—èŠ‚æ•°å¤§äºæˆ–ç­‰äº å…¶ä½æ°´ä½æ ‡è®°, <strong>ä¸”å¥—æ¥å­—å·²ç»è¿æ¥, æˆ–å¥—æ¥å­—ä¸éœ€è¦è¿æ¥UDP</strong></li>
<li>socketçš„å†™æ“ä½œè¢«å…³é—­, å¯¹è¢«å…³é—­çš„socketæ‰§è¡Œå†™æ“ä½œå°†ä¼šè§¦å‘ä¸€ä¸ªSIGPIPEä¿¡å·</li>
<li>socketä½¿ç”¨éé˜»å¡connect è¿æ¥æˆåŠŸæˆ–å¤±è´¥å</li>
<li>socketä¸Šæœ‰æœªå¤„ç†çš„é”™è¯¯ å¥—æ¥å­—çš„å†™æ“ä½œä¸é˜»å¡ å¹¶è¿”å›-1</li>
</ul>
<p>å¼‚å¸¸æ¡ä»¶</p>
<ul>
<li>å‘é€å¸¦å¤–æ•°æ®</li>
</ul>
<p>selectå‡½æ•°åœ¨ç¬¬äºŒä¸ªå‚æ•°åˆ—è¡¨ å¯è¯»çš„æ—¶å€™è¿”å›<br>æˆ–è€…æ˜¯ç­‰åˆ°äº†è§„å®šçš„æ—¶é—´è¿”å›</p>
<p>è¿”å›ä¹‹å ç¬¬äºŒä¸ªå‚æ•°æŒ‡å‘fdsetçš„é›†åˆ è¢«ä¿®æ”¹ä¸ºå¯è¯»çš„fdåˆ—è¡¨<br>è¿™å°±éœ€è¦æ¯æ¬¡è¿”å›åéƒ½æ›´æ–° fdseté›†åˆ</p>
<p>è¿”å›å æ­¤å‡½æ•°çš„è¿”å›å€¼ä¸ºå¯è¯»çš„fdæ•°é‡, éå†fdseté›†åˆ åŒæ—¶ä½¿ç”¨FD_ISSETåˆ¤æ–­fdset<br> æ˜¯å¦åœ¨å…¶ä¸­<br>ç„¶ååˆ¤æ–­æ­¤fdæ˜¯å¦ä¸ºlistenfd å¦‚æœæ˜¯åˆ™æ¥å—æ–°çš„è¿æ¥ å¦‚æœä¸æ˜¯è¯´æ˜æ˜¯å·²ç»æ¥å—çš„å…¶ä»–fd åˆ¤æ–­æ˜¯æœ‰æ•°æ®å¯è¯»<br>è¿˜æ˜¯æ­¤è¿æ¥æ–­å¼€</p>
<h2 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h2><p><strong>poll</strong><br><img src="https://lsmg-img.oss-cn-beijing.aliyuncs.com/Linux%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E8%AE%B0%E5%BD%95/poll%E6%97%B6%E9%97%B4%E7%B1%BB%E5%9E%8B1.png" alt=""><br><img src="https://lsmg-img.oss-cn-beijing.aliyuncs.com/Linux%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E8%AE%B0%E5%BD%95/poll%E6%97%B6%E9%97%B4%E7%B1%BB%E5%9E%8B2.png" alt=""></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="comment">// fds ç»“æ„ä½“ç±»å‹æ•°ç»„ æŒ‡å®šæˆ‘ä»¬æ„Ÿå…´è¶£çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šå‘ç”Ÿçš„å¯è¯»å¯å†™å’Œå¼‚å¸¸äº‹ä»¶\</span></span><br><span class="line"><span class="comment">// nfds éå†ç»“åˆå¤§å° å·¦é—­å³å¼€</span></span><br><span class="line"><span class="comment">// timeout å•ä½ä¸ºæ¯«ç§’ -1 ä¸ºé˜»å¡ 0 ä¸ºç«‹å³è¿”å›</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">poll</span><span class="params">(struct pollfd* fds, <span class="keyword">nfds_t</span> nfds, <span class="keyword">int</span> timeout)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line">	short events;  <span class="comment">//æ³¨å†Œçš„äº‹ä»¶, å‘ŠçŸ¥pollç›‘å¬fdä¸Šçš„å“ªäº›äº‹ä»¶</span></span><br><span class="line">	short revents; <span class="comment">// å®é™…å‘ç”Ÿçš„äº‹ä»¶</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> exit_if(r, ...) \</span></span><br><span class="line">&#123;   \</span><br><span class="line">    <span class="keyword">if</span> (r)  \</span><br><span class="line">    &#123;   \</span><br><span class="line">        <span class="built_in">printf</span>(__VA_ARGS__);    \</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"errno no: %d, error msg is %s"</span>, errno, strerror(errno));    \</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);    \</span><br><span class="line">    &#125;   \</span><br><span class="line">&#125;   \</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">client_info</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *ip_;</span><br><span class="line">    <span class="keyword">int</span> port_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> port = <span class="number">8001</span>;</span><br><span class="line">    <span class="keyword">char</span> ip[] = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>;</span></span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    address.sin_addr.s_addr = htons(INADDR_ANY);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> listenfd = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    exit_if(listenfd &lt; <span class="number">0</span>, <span class="string">"socket error\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = bind(listenfd, (struct sockaddr*)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    exit_if(ret == <span class="number">-1</span>, <span class="string">"bind error\n"</span>);</span><br><span class="line"></span><br><span class="line">    ret = <span class="built_in">listen</span>(listenfd, <span class="number">5</span>);</span><br><span class="line">    exit_if(ret == <span class="number">-1</span>, <span class="string">"listen error\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">int</span> MAX_CLIENTS = <span class="number">1024</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">polls</span>[<span class="title">MAX_CLIENTS</span>] = &#123;</span>&#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">client_info</span> <span class="title">clientsinfo</span>[<span class="title">MAX_CLIENTS</span>] = &#123;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    polls[<span class="number">3</span>].fd = listenfd;</span><br><span class="line">    polls[<span class="number">3</span>].events = POLLIN | POLLRDHUP;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = poll(polls, MAX_CLIENTS + <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line">        exit_if(ret == <span class="number">-1</span>, <span class="string">"poll error\n"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">3</span>; i &lt;= MAX_CLIENTS; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> fd = polls[i].fd;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (polls[i].revents &amp; POLLRDHUP)</span><br><span class="line">            &#123;</span><br><span class="line">                polls[i].events = <span class="number">0</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"close fd-%d from %s:%d\n"</span>, fd, clientsinfo[fd].ip_, clientsinfo[fd].port_);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (polls[i].revents &amp; POLLIN)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (fd == listenfd)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">client_address</span>;</span></span><br><span class="line">                    <span class="keyword">socklen_t</span> client_addresslen = <span class="keyword">sizeof</span>(client_address);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">int</span> clientfd = accept(listenfd, (struct sockaddr*)&amp;client_address,</span><br><span class="line">                            &amp;client_addresslen);</span><br><span class="line"></span><br><span class="line">                    <span class="class"><span class="keyword">struct</span> <span class="title">client_info</span> *<span class="title">clientinfo</span> = &amp;<span class="title">clientsinfo</span>[<span class="title">clientfd</span>];</span></span><br><span class="line"></span><br><span class="line">                    clientinfo-&gt;ip_ = inet_ntoa(client_address.sin_addr);</span><br><span class="line">                    clientinfo-&gt;port_ = ntohs(client_address.sin_port);</span><br><span class="line"></span><br><span class="line">                    exit_if(clientfd &lt; <span class="number">0</span>, <span class="string">"accpet error, from %s:%d\n"</span>, clientinfo-&gt;ip_,</span><br><span class="line">                            clientinfo-&gt;port_);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"accept from %s:%d\n"</span>, clientinfo-&gt;ip_, clientinfo-&gt;port_);</span><br><span class="line"></span><br><span class="line">                    polls[clientfd].fd = clientfd;</span><br><span class="line">                    polls[clientfd].events = POLLIN | POLLRDHUP;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">char</span> <span class="built_in">buffer</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="built_in">memset</span>(<span class="built_in">buffer</span>, <span class="string">'\0'</span>, <span class="keyword">sizeof</span>(<span class="built_in">buffer</span>));</span><br><span class="line"></span><br><span class="line">                    ret = <span class="built_in">read</span>(fd, <span class="built_in">buffer</span>, <span class="number">1024</span>);</span><br><span class="line">                    <span class="keyword">if</span>(ret == <span class="number">0</span>)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">close</span>(fd);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">"recv from %s:%d:\n%s\n"</span>, clientsinfo[fd].ip_,</span><br><span class="line">                               clientsinfo[fd].port_, <span class="built_in">buffer</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p><strong>epoll</strong></p>
<p>epollæ˜¯Linuxç‰¹æœ‰çš„I/Oå¤ç”¨å‡½æ•°, å®ç°ä¸Šä¸select,pollæœ‰å¾ˆå¤§çš„å·®å¼‚</p>
<ul>
<li>epollä½¿ç”¨ä¸€ç»„å‡½æ•°å®Œæˆä»»åŠ¡</li>
<li>epollæŠŠç”¨æˆ·å…³å¿ƒçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶æ”¾åœ¨å†…æ ¸é‡Œçš„ä¸€ä¸ªäº‹ä»¶è¡¨ä¸­</li>
<li>epollæ— éœ€æ¯æ¬¡è°ƒç”¨éƒ½ä¼ å…¥æ–‡ä»¶æè¿°ç¬¦é›†æˆ–äº‹ä»¶é›†.</li>
</ul>
<p>æœ‰ç‰¹å®šçš„æ–‡ä»¶æè¿°ç¬¦åˆ›å»ºå‡½æ•°, æ¥æ ‡è¯†è¿™ä¸ªäº‹ä»¶è¡¨<code>epoll_create()</code><br><code>epoll_ctl()</code> ç”¨æ¥æ“ä½œè¿™ä¸ªå†…æ ¸äº‹ä»¶è¡¨<br><code>epoll_wait()</code> ä¸ºä¸»è¦å‡½æ•° æˆåŠŸè¿”å›å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•° å¤±è´¥è¿”å›-1<br>å¦‚æœ<code>epoll_wait()</code>å‡½æ•°æ£€æµ‹åˆ°äº‹ä»¶,å°±å°†æ‰€æœ‰å°±ç»ªçš„äº‹ä»¶ä»å†…æ ¸äº‹ä»¶è¡¨(ç”±ç¬¬ä¸€ä¸ªå‚æ•°, epoll_createè¿”å›çš„ç»“æœ) ä¸­å¤åˆ¶åˆ°ç¬¬äºŒä¸ªå‚æ•°eventæŒ‡å‘çš„æ•°ç»„ä¸­, è¿™ä¸ªæ•°ç»„åªç”¨äºè¾“å‡º<code>epoll_wait</code>æ£€æµ‹åˆ°çš„å°±ç»ªäº‹ä»¶.</p>
<p><em>eventä¸åŒäºselectå’Œpollçš„æ•°ç»„å‚æ•° æ—¢ç”¨äºä¼ å…¥ç”¨æˆ·æ³¨å†Œçš„äº‹ä»¶, åˆç”¨äºè¾“å‡ºå†…æ ¸æ£€æµ‹åˆ°çš„å°±ç»ªäº‹ä»¶, æé«˜äº†æ•ˆç‡</em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç´¢å¼•pollè¿”å›çš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="keyword">int</span> ret = poll(fds, MAX_EVENT_NUMBER - <span class="number">1</span>);</span><br><span class="line"><span class="comment">// éå†</span></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; MAX_EVENT_NUMBER; ++i) &#123;</span><br><span class="line">	<span class="keyword">if</span>(fds[i].revents &amp; POLLIN) &#123;</span><br><span class="line">		<span class="keyword">int</span> sockfd = fds[i].fd;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç´¢å¼•epollè¿”å›çš„å°±ç»ªæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="keyword">int</span> ret = epoll_wait(epoll_fd, events, MAX_EVENT_NUMBER,  <span class="number">-1</span>);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ret; i++) &#123;</span><br><span class="line">	<span class="keyword">int</span> sockfd = events[i].data.fd;</span><br><span class="line">	<span class="comment">// sockfd ä¸€å®šå°±ç»ª ?????</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>LTå’ŒETæ¨¡å¼</strong><br>LT(ç”µå¹³è§¦å‘, é»˜è®¤çš„å·¥ä½œæ¨¡å¼)<br>LTæ¨¡å¼ä¸‹çš„epollç›¸å½“äºä¸€ä¸ªæ•ˆç‡è¾ƒé«˜çš„poll<br>epoll_waitå°†ä¼šä¸€åªé€šçŸ¥ä¸€ä¸ªäº‹ä»¶çŸ¥é“è¿™ä¸ªäº‹ä»¶è¢«å¤„ç†</p>
<p>ET(è¾¹æ²¿è§¦å‘, epollçš„é«˜æ•ˆå·¥ä½œæ¨¡å¼)æ¨¡å¼<br>å½“å‘epollå†…æ ¸äº‹ä»¶è¡¨ä¸­æ³¨å†Œä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šçš„EPOLLETäº‹ä»¶çš„æ—¶å€™, epollå°†ç”¨ETæ¨¡å¼æ¥æ“ä½œè¿™ä¸ª<br>æ–‡ä»¶æè¿°ç¬¦<br>epoll_waitåªä¼šé€šçŸ¥ä¸€æ¬¡, ä¸è®ºè¿™ä¸ªäº‹ä»¶æœ‰æ²¡æœ‰å®Œæˆ</p>
<p>ETæ¨¡å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-&gt; 123456789-123456789-123456789</span><br><span class="line">event trigger once</span><br><span class="line">get 9bytes of content: 123456789</span><br><span class="line">get 9bytes of content: -12345678</span><br><span class="line">get 9bytes of content: 9-1234567</span><br><span class="line">get 4bytes of content: 89</span><br><span class="line">read later</span><br></pre></td></tr></table></figure>
<p>LTæ¨¡å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">-&gt; 123456789-123456789-123456789</span><br><span class="line">event trigger once</span><br><span class="line">get 9bytes of contents: 123456789</span><br><span class="line">event trigger once</span><br><span class="line">get 9bytes of contents: -12345678</span><br><span class="line">event trigger once</span><br><span class="line">get 9bytes of contents: 9-1234567</span><br><span class="line">event trigger once</span><br><span class="line">get 4bytes of contents: 89</span><br></pre></td></tr></table></figure>
<p>ETæ¨¡å¼æœ‰ä»»åŠ¡åˆ°æ¥å°±å¿…é¡»åšå®Œ, å› ä¸ºåç»­å°†ä¸ä¼šç»§ç»­é€šçŸ¥è¿™ä¸ªäº‹ä»¶, æ‰€ä»¥ETæ˜¯epollçš„é«˜æ•ˆå·¥ä½œæ¨¡å¼<br>LTæ¨¡å¼åªè¦äº‹ä»¶æ²¡è¢«å¤„ç†å°±ä¼šä¸€ç›´é€šçŸ¥</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;epoll.h&gt;</span></span></span><br><span class="line"><span class="comment">// size å‚æ•°åªæ˜¯ç»™å†…æ ¸ä¸€ä¸ªæç¤º, äº‹ä»¶è¡¨éœ€è¦å¤šå¤§</span></span><br><span class="line"><span class="comment">// å‡½æ•°è¿”å›å…¶ä»–æ‰€æœ‰epollç³»ç»Ÿè°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°, æ¥æŒ‡å®šè¦è®¿é—®çš„å†…æ ¸äº‹ä»¶è¡¨</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_create</span><span class="params">(<span class="keyword">int</span> <span class="built_in">size</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// epfd ä¸º epoll_createçš„è¿”å›å€¼</span></span><br><span class="line"><span class="comment">// opä¸ºæ“ä½œç±»å‹</span></span><br><span class="line"><span class="comment">// - EPOLL_CTL_ADD å‘äº‹ä»¶è¡¨ä¸­æ³¨å†Œfdä¸Šçš„äº‹ä»¶</span></span><br><span class="line"><span class="comment">// - EPOLL_CTL_MOD ä¿®æ”¹fdä¸Šçš„æ³¨å†Œäº‹ä»¶</span></span><br><span class="line"><span class="comment">// - EPOLL_CTL_DEL åˆ é™¤fdä¸Šçš„æ³¨å†Œäº‹ä»¶</span></span><br><span class="line"><span class="comment">// fd ä¸ºè¦æ“ä½œçš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="keyword">int</span> epfd, <span class="keyword">int</span> op, <span class="keyword">int</span> fd, struct epoll_event* event)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="keyword">_uint32_t</span> events; <span class="comment">// epolläº‹ä»¶</span></span><br><span class="line">	<span class="keyword">epoll_data_t</span> data; <span class="comment">// ç”¨æˆ·æ•°æ® æ˜¯ä¸€ä¸ªè”åˆä½“</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> epoll_data</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">void</span>* ptr; <span class="comment">// ptr fd ä¸èƒ½åŒæ—¶ä½¿ç”¨</span></span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line">	<span class="keyword">uint32_t</span> u32;</span><br><span class="line">	<span class="keyword">uint64_t</span> u64;</span><br><span class="line">&#125;<span class="keyword">epoll_data_t</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// maxeventsç›‘å¬äº‹ä»¶æ•° å¿…é¡»å¤§äº0</span></span><br><span class="line"><span class="comment">// timeout ä¸º-1 è¡¨ç¤ºé˜»å¡</span></span><br><span class="line"><span class="comment">// æˆåŠŸè¿”å›å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•° å¤±è´¥è¿”å›-1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="keyword">int</span> epfd, struct epoll_event* events, <span class="keyword">int</span> maxevents, <span class="keyword">int</span> timeout)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="ä¸‰ç§IOå¤ç”¨çš„æ¯”è¾ƒ"><a href="#ä¸‰ç§IOå¤ç”¨çš„æ¯”è¾ƒ" class="headerlink" title="ä¸‰ç§IOå¤ç”¨çš„æ¯”è¾ƒ"></a>ä¸‰ç§IOå¤ç”¨çš„æ¯”è¾ƒ</h2><p><code>select</code>ä»¥åŠ<code>poll</code>å’Œ<code>epoll</code><br>ç›¸åŒ</p>
<ul>
<li>éƒ½èƒ½åŒæ—¶ç›‘å¬å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦, éƒ½å°†ç­‰å¾…timeoutå‚æ•°æŒ‡å®šçš„è¶…æ—¶æ—¶é—´, ç›´åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿ.</li>
<li>è¿”å›å€¼ä¸ºå°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦æ•°é‡, è¿”å›0åˆ™è¡¨ç¤ºæ²¡æœ‰äº‹ä»¶å‘ç”Ÿ</li>
<li><img src="https://lsmg-img.oss-cn-beijing.aliyuncs.com/Linux%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E8%AE%B0%E5%BD%95/%E4%B8%89%E7%A7%8DIO%E5%A4%8D%E7%94%A8%E6%AF%94%E8%BE%83.png" alt=""></li>
</ul>
<h2 id="I-O-å¤ç”¨çš„é«˜çº§åº”ç”¨-éé˜»å¡connect"><a href="#I-O-å¤ç”¨çš„é«˜çº§åº”ç”¨-éé˜»å¡connect" class="headerlink" title="I/O å¤ç”¨çš„é«˜çº§åº”ç”¨, éé˜»å¡connect"></a>I/O å¤ç”¨çš„é«˜çº§åº”ç”¨, éé˜»å¡connect</h2><p>connectå‡ºé”™çš„æ—¶å€™ä¼šè¿”å›ä¸€ä¸ªerrnoå€¼ EINPROGRESS - è¡¨ç¤ºå¯¹éé˜»å¡socketè°ƒç”¨connect, è¿æ¥åˆæ²¡æœ‰ç«‹å³å»ºç«‹çš„æ—¶å€™, è¿™æ—¶å¯ä»¥è°ƒç”¨selectå’Œpollå‡½æ•°æ¥ç›‘å¬è¿™ä¸ªè¿æ¥å¤±è´¥çš„socketä¸Šçš„å¯å†™äº‹ä»¶.</p>
<p>å½“å‡½æ•°è¿”å›çš„æ—¶å€™, å¯ä»¥ç”¨getsockoptæ¥è¯»å–é”™è¯¯ç , å¹¶æ¸…æ¥šè¯¥socketä¸Šçš„é”™è¯¯. é”™è¯¯ç ä¸º0è¡¨ç¤ºæˆåŠŸ</p>
<h1 id="ç¬¬åç« ä¿¡å·"><a href="#ç¬¬åç« ä¿¡å·" class="headerlink" title="ç¬¬åç« ä¿¡å·"></a>ç¬¬åç« ä¿¡å·</h1><h2 id="Api"><a href="#Api" class="headerlink" title="Api"></a>Api</h2><p>å‘é€ä¿¡å·Api</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// pid &gt; 0 å‘é€ç»™PIDä¸ºpidæ ‡è¯†çš„è¿›ç¨‹</span></span><br><span class="line"><span class="comment">//  0 å‘é€ç»™æœ¬è¿›ç¨‹ç»„çš„å…¶ä»–è¿›ç¨‹</span></span><br><span class="line"><span class="comment">// -1 å‘é€ç»™è¿›ç¨‹ä»¥å¤–çš„æ‰€æœ‰è¿›ç¨‹, ä½†å‘é€è€…éœ€è¦æœ‰å¯¹ç›®æ ‡è¿›ç¨‹å‘é€ä¿¡å·çš„æƒé™</span></span><br><span class="line"><span class="comment">// &lt; -1 å‘é€ç»™ç»„IDä¸º -pid çš„è¿›ç¨‹ç»„ä¸­çš„æ‰€æœ‰æˆå‘˜</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡ºé”™ä¿¡æ¯ EINVAL æ— æ•ˆä¿¡å·, EPERM è¯¥è¿›ç¨‹æ²¡æœ‰æƒé™ç»™ä»»ä½•ä¸€ä¸ªç›®æ ‡è¿›ç¨‹ ESRCH ç›®æ ‡è¿›ç¨‹(ç»„) ä¸å­˜åœ¨</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">kill</span><span class="params">(<span class="keyword">pid_t</span> pid, <span class="keyword">int</span> sig)</span></span>;</span><br></pre></td></tr></table></figure>
<p>æ¥æ”¶ä¿¡å·Api</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span><span class="params">(*<span class="keyword">_sighandler_t</span>)</span> <span class="params">(<span class="keyword">int</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;bits/signum.h&gt; // æ­¤å¤´æ–‡ä»¶ä¸­æœ‰æ‰€æœ‰çš„linuxå¯ç”¨ä¿¡å·</span></span></span><br><span class="line"><span class="comment">// å¿½ç•¥ç›®æ ‡ä¿¡å·</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIG_DFL ((_sighandler_t) 0)</span></span><br><span class="line"><span class="comment">// ä½¿ç”¨ä¿¡å·çš„é»˜è®¤å¤„ç†æ–¹å¼</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SIG_IGN ((_sighandler_t) 1)</span></span><br></pre></td></tr></table></figure>
<p>å¸¸ç”¨ä¿¡å·</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SIGHUP æ§åˆ¶ç»ˆç«¯æŒ‚èµ·</span><br><span class="line">SIGPIPE å¾€è¯»ç«¯è¢«å…³é—­çš„ç®¡é“æˆ–è€…socketè¿æ¥ä¸­å†™æ•°æ®</span><br><span class="line">SIGURG socketè¿æ¥ä¸Šæ”¶åˆ°ç´§æ€¥æ•°æ®</span><br><span class="line">SIGALRM ç”±alarmæˆ–setitimerè®¾ç½®çš„å®æ—¶é—¹é’Ÿè¶…æ—¶å¼•èµ·</span><br><span class="line">SIGCHLD å­è¿›ç¨‹çŠ¶æ€å˜åŒ–</span><br></pre></td></tr></table></figure>
<p>ä¿¡å·å‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸ºä¸€ä¸ªä¿¡å·è®¾ç½®å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="comment">// _handler æŒ‡å®šsigçš„å¤„ç†å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">_sighandler_t</span> <span class="title">signal</span><span class="params">(<span class="keyword">int</span> sig, <span class="keyword">__sighandler_t</span> _handler)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sigaction</span><span class="params">(<span class="keyword">int</span> sig, struct sigaction* act, struct sigaction* oact)</span></span></span><br></pre></td></tr></table></figure>
<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><p>ä¿¡å·æ˜¯ç”¨æˆ·, ç³»ç»Ÿ, æˆ–è€…è¿›ç¨‹å‘é€ç»™ç›®æ ‡è¿›ç¨‹çš„ä¿¡æ¯, ä»¥é€šçŸ¥ç›®æ ‡è¿›ç¨‹æŸä¸ªçŠ¶æ€çš„æ”¹å˜æˆ–è€…ç³»ç»Ÿå¼‚å¸¸.<br>äº§ç”Ÿæ¡ä»¶</p>
<ul>
<li>å¯¹äºå‰å°è¿›ç¨‹<br>ç”¨æˆ·å¯ä»¥é€šè¿‡è¾“å…¥ç‰¹æ®Šçš„ç»ˆç«¯å­—ç¬¦æ¥ç»™å®ƒå‘é€ä¿¡å·, CTRL+C é€šå¸¸ä¸ºä¸€ä¸ªä¸­æ–­ä¿¡å· <code>SIGINT</code></li>
<li>ç³»ç»Ÿå¼‚å¸¸<br>æµ®ç‚¹å¼‚å¸¸å’Œéæ³•å†…å­˜æ®µçš„è®¿é—®</li>
<li>ç³»ç»ŸçŠ¶æ€å˜åŒ–<br>ç”±alarmå®šæ—¶å™¨åˆ°æœŸå°†å¼•èµ·<code>SIGALRM</code>ä¿¡å·</li>
<li>è¿è¡Œkillå‘½ä»¤æˆ–è°ƒç”¨killå‡½æ•°</li>
</ul>
<p><em>æœåŠ¡å™¨å¿…é¡»å¤„ç†(è‡³å°‘å¿½ç•¥) ä¸€äº›å¸¸è§çš„ä¿¡å·, ä»¥å…å¼‚å¸¸ç»ˆæ­¢</em></p>
<p>ä¸­æ–­ç³»ç»Ÿè°ƒç”¨?</p>
<h1 id="ç¬¬åä¸€ç« å®šæ—¶å™¨"><a href="#ç¬¬åä¸€ç« å®šæ—¶å™¨" class="headerlink" title="ç¬¬åä¸€ç« å®šæ—¶å™¨"></a>ç¬¬åä¸€ç« å®šæ—¶å™¨</h1><h2 id="socketé€‰é¡¹SO-RCVTIMEO-å’Œ-SO-SNDTIMEO"><a href="#socketé€‰é¡¹SO-RCVTIMEO-å’Œ-SO-SNDTIMEO" class="headerlink" title="socketé€‰é¡¹SO_RCVTIMEO å’Œ SO_SNDTIMEO"></a>socketé€‰é¡¹<code>SO_RCVTIMEO</code> å’Œ <code>SO_SNDTIMEO</code></h2><p><img src="https://lsmg-img.oss-cn-beijing.aliyuncs.com/Linux%E9%AB%98%E6%80%A7%E8%83%BD%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B%E8%AF%BB%E4%B9%A6%E8%AE%B0%E5%BD%95/SO_RCVTIMEO%E5%92%8CSO_SNDTIMEO%E9%80%89%E9%A1%B9%E7%9A%84%E4%BD%9C%E7%94%A8.png" alt=""></p>
<p>ä½¿ç”¨ç¤ºä¾‹, é€šè¿‡è®¾ç½®å¯¹åº”çš„SO_SNDTIMEO å¾—åˆ°è¶…æ—¶åçš„è·¯çº¿</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">timeout_connect</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* ip, <span class="keyword">const</span> <span class="keyword">int</span> port, <span class="keyword">const</span> <span class="keyword">int</span> sec)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">address</span>&#123;</span>&#125;;</span><br><span class="line">    address.sin_family = AF_INET;</span><br><span class="line">    address.sin_port = htons(port);</span><br><span class="line">    address.sin_addr.s_addr = inet_addr(ip);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> sockfd = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    exit_if(sockfd &lt; <span class="number">0</span>, <span class="string">"socket error\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">timeout</span>&#123;</span>&#125;;</span><br><span class="line">    timeout.tv_sec = sec;</span><br><span class="line">    timeout.tv_usec = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">socklen_t</span> timeout_len = <span class="keyword">sizeof</span>(timeout);</span><br><span class="line"></span><br><span class="line">    setsockopt(sockfd, SOL_SOCKET, SO_SNDTIMEO, &amp;timeout, timeout_len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> ret = <span class="built_in">connect</span>(sockfd, (struct sockaddr*)&amp;address, <span class="keyword">sizeof</span>(address));</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">		<span class="comment">// å½“ errnoä¸ºEINPROGRESS è¯´æ˜ ç­‰å¾…äº† 10Såä¾ç„¶æ— æ³•è¿æ¥æˆåŠŸ å®ç°äº†å®šæ—¶å™¨</span></span><br><span class="line">        <span class="keyword">if</span> (errno == EINPROGRESS)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"connecting timeout, process timeout logic\n"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"error occur when connecting to server\n"</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sockfd;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    exit_if(argc &lt;= <span class="number">2</span>, <span class="string">"wrong number of parameters\n"</span>)</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* ip = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> port = atoi(argv[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> sockfd = timeout_connect(ip, port, <span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (sockfd &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SIGALRMä¿¡å·-åŸºäºå‡åºé“¾è¡¨çš„å®šæ—¶å™¨"><a href="#SIGALRMä¿¡å·-åŸºäºå‡åºé“¾è¡¨çš„å®šæ—¶å™¨" class="headerlink" title="SIGALRMä¿¡å·-åŸºäºå‡åºé“¾è¡¨çš„å®šæ—¶å™¨"></a>SIGALRMä¿¡å·-åŸºäºå‡åºé“¾è¡¨çš„å®šæ—¶å™¨</h2><p>ç”±alarmå’Œsetitimerå‡½æ•°è®¾å®šçš„å®æ—¶é—¹é’Ÿä¸€æ—¦è¶…æ—¶, å°†ä¼šè§¦å‘SIGALRMä¿¡å·, ç”¨ä¿¡å·å¤„ç†å‡½æ•°å¤„ç†å®šæ—¶ä»»åŠ¡<br> ç›¸å…³çš„ä»£ç æ”¾åœ¨äº†githubä¸Š ä»£ç è¿˜æ˜¯å¾ˆå¤šçš„å°±ä¸æ”¾ä¸Šæ¥äº†<a href="https://github.com/rjd67441/Notes-HighPerformanceLinuxServerProgramming/tree/master/12.%20%E4%BB%A3%E7%A0%81%E6%B8%85%E5%8D%9511-2%E5%92%8C11-3%E5%8F%8A11-4%20%E9%93%BE%E8%A1%A8%E5%AE%9A%E6%97%B6%E5%99%A8%2C%20%E5%A4%84%E7%90%86%E9%9D%9E%E6%B4%BB%E5%8A%A8%E8%BF%9E%E6%8E%A5" target="_blank" rel="noopener">è¿æ¥</a></p>
<p>æ€»ç»“æ”¾åœ¨äº† æ—¥è®°çš„åšå®¢ä¸Š é“¾æ¥åé¢å†ç”©å‡ºæ¥</p>
<h2 id="IOå¤ç”¨ç³»ç»Ÿè°ƒç”¨çš„è¶…æ—¶å‚æ•°"><a href="#IOå¤ç”¨ç³»ç»Ÿè°ƒç”¨çš„è¶…æ—¶å‚æ•°" class="headerlink" title="IOå¤ç”¨ç³»ç»Ÿè°ƒç”¨çš„è¶…æ—¶å‚æ•°"></a>IOå¤ç”¨ç³»ç»Ÿè°ƒç”¨çš„è¶…æ—¶å‚æ•°</h2><h2 id="é«˜æ€§èƒ½å®šæ—¶å™¨"><a href="#é«˜æ€§èƒ½å®šæ—¶å™¨" class="headerlink" title="é«˜æ€§èƒ½å®šæ—¶å™¨"></a>é«˜æ€§èƒ½å®šæ—¶å™¨</h2><h2 id="æ—¶é—´è½®"><a href="#æ—¶é—´è½®" class="headerlink" title="# æ—¶é—´è½®"></a># æ—¶é—´è½®</h2><h2 id="æ—¶é—´å †"><a href="#æ—¶é—´å †" class="headerlink" title="# æ—¶é—´å †"></a># æ—¶é—´å †</h2><h1 id="ç¬¬åäºŒç« é«˜æ€§èƒ½IOæ¡†æ¶åº“"><a href="#ç¬¬åäºŒç« é«˜æ€§èƒ½IOæ¡†æ¶åº“" class="headerlink" title="ç¬¬åäºŒç« é«˜æ€§èƒ½IOæ¡†æ¶åº“"></a>ç¬¬åäºŒç« é«˜æ€§èƒ½IOæ¡†æ¶åº“</h1><p>å¦å‡ºä¸€ç¯‡åšå®¢</p>

      </div>
        <div class="support-author">
          <p>æ„Ÿè°¢æ‚¨çš„é˜…è¯»ã€‚ ğŸ™
          <a href="https://blog.lsmg.xyz/index.html" target="_blank">å…³äºè½¬è½½è¯·çœ‹è¿™é‡Œ</a>
            <!--<a class="btn-pay"  href="#pay-modal">Â¥ æ‰“èµæ”¯æŒ</a>-->
          </p>
        </div>
        <!--
            <div class="like ">
              <div class="like-button">
                <a id="like-note" href="">
                  <i class="icon-heart"></i>å–œæ¬¢
                </a>
              </div>
              <span id="likes-count">256</span>
            </div>
        -->
        <div class="otherLink">
          <div class="previous">
          </div>
          <div class="next">
          </div>
        </div>
        <div class="comments" id="comments">
          

        </div>
      </div>
    </div>
   </div>
</main>
<div class="footer">
  <div class="info">
    <p>
    <a href="https://hexo.io" target="_blank" rel="noopener"> Hexo </a> å¼ºåŠ›é©±åŠ¨ |
      <a href="https://github.com/Youthink/hexo-themes-yearn" target="_blank" rel="noopener"> Yearn </a>
      ä¸»é¢˜
    </p>
    <p>&copy;2018-2020 å½¼å²¸é±¼çš„åšå®¢</p>
  </div>
</div>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<script>//console
  var consoleConfig = '\næ¬¢è¿è®¿é—® https://hufangyun.com ï¼Œå›´è§‚å°çŒ¿å¤§åœ£çš„åšå®¢(ã¥ï½¡â—•â€¿â€¿â—•ï½¡)ã¥ï¼\n,\næœ¬åšå®¢ä½¿ç”¨ %cHexo%c æ­å»ºï¼Œåšå®¢ä¸»é¢˜ä¸ºå°çŒ¿å¤§åœ£å¼€å‘çš„ %chexo-themes-yearn%c ~~~ ğŸ‰ğŸ‰ğŸ‰ \n\næºç  https://github.com/Youthink/hexo-themes-yearn \n\nå¦‚æœå–œæ¬¢å¯ä»¥ star æ”¯æŒä¸€ä¸‹ â¤ï¸~\n,\næ‰«æä¸‹é¢çš„äºŒç»´ç ï¼Œåœ¨æ‰‹æœºä¸ŠæŸ¥çœ‹åšå®¢ï¼\n,https://static.hufangyun.com/blog-url-qrcode-180-180.png,\n æƒ³çŸ¥é“è¿™ä¸ªæ•ˆæœå¦‚ä½•å®ç°çš„ï¼Ÿåšå®¢å†…æœç´¢ console å½©è›‹ ğŸš€ ï¼\n'.split(',');
  var canConsole = false;
  var consoleInfo = (function(consoleConfig) {
  if (!canConsole || !consoleConfig || consoleConfig.length < 1) {
    return;
  }
  var consoleColor = '#6190e8';
  var _console;
  var backgroundTextStyle = 'padding: 1px 5px;color: #fff;background: ' + consoleColor + ';'
  var textStyle = 'color: ' + consoleColor + ';';

  consoleConfig.map(o => {
    var num = (o.match(/%c/g) || []).length;
    if(/^http(s)?:\/\//.test(o)) {
      console.log('%c     ', 'background: url(' + o + ') no-repeat left center;font-size: 180px;');
      return;
    }
    if (num > 0) {
      var logArguments = [];
      for (var i = 0; i < num; i++) {
        if (i % 2 === 0) {
          logArguments.push(backgroundTextStyle);
        } else {
          logArguments.push(textStyle);
        }
      }
      (_console = console).log.apply(_console, ['%c' + o, textStyle].concat(logArguments));
      return;
    }
    console.log('%c' + o, textStyle);
  });
}(consoleConfig));</script><script type="text/javascript" src="/./js/main.js"></script>

  <script src="//at.alicdn.com/t/font_159214_mvtxvg9me9.js"></script>
</body>
</html>
